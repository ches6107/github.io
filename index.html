<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>生產記錄管理系統 (正式格式版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: "Inter", "Noto Sans TC", "微軟正黑體", sans-serif; 
            background-color: #f1f5f9;
            color: #1e293b;
        }
        
        .page-break {
            page-break-after: always;
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            border: 1.5px solid #000;
            background: white;
            table-layout: fixed;
            /* 讓表格在容器中置中 */
            margin-left: auto;
            margin-right: auto;
        }
        
        .report-table th, .report-table td {
            border: 1px solid #000;
            height: 32px;
            padding: 0;
            vertical-align: middle;
            text-align: center;
            font-size: 13px;
        }

        .label-bg { background-color: #ffffff; font-weight: 500; }

        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            text-align: center;
            font-size: 14px;
            background: transparent;
        }

        select.cell-input { appearance: none; cursor: pointer; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page-break {
                box-shadow: none;
                margin: 0 auto;
                padding: 5mm;
                page-break-after: always;
                max-width: none;
            }
            .report-table { border: 1.5px solid #000; }
        }

        .text-left-cell { text-align: left !important; padding-left: 6px !important; }
        
        .page-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: rgba(0,0,0,0.05);
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
        }
        
        .relative-container { position: relative; }
    </style>
</head>
<body class="p-2 sm:p-4">

    <!-- 設定彈窗 -->
    <div id="settingsModal" class="no-print" style="display: none;">
        <div class="fixed inset-0 bg-black/50 z-[1000] flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                    <h2 class="font-bold">選單資料管理</h2>
                    <button onclick="closeModal()" class="text-2xl">&times;</button>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">昇絲人員</label>
                        <div class="flex gap-1"><input type="text" id="new_staff" class="border flex-1 px-2 py-1 rounded"><button onclick="addItem('staff')" class="bg-blue-600 text-white px-2 rounded">+</button></div>
                        <ul id="list_staff" class="border rounded h-24 overflow-y-auto text-sm"></ul>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">管紗代號</label>
                        <div class="flex gap-1"><input type="text" id="new_yarn" class="border flex-1 px-2 py-1 rounded"><button onclick="addItem('yarn')" class="bg-blue-600 text-white px-2 rounded">+</button></div>
                        <ul id="list_yarn" class="border rounded h-24 overflow-y-auto text-sm"></ul>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-red-500 uppercase">斷絲原因 (O)</label>
                        <div class="flex gap-1"><input type="text" id="new_breakReason" class="border flex-1 px-2 py-1 rounded border-red-200"><button onclick="addItem('breakReason')" class="bg-red-600 text-white px-2 rounded">+</button></div>
                        <ul id="list_breakReason" class="border rounded h-24 overflow-y-auto text-sm"></ul>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">空錠原因 (X)</label>
                        <div class="flex gap-1"><input type="text" id="new_emptyReason" class="border flex-1 px-2 py-1 rounded"><button onclick="addItem('emptyReason')" class="bg-slate-700 text-white px-2 rounded">+</button></div>
                        <ul id="list_emptyReason" class="border rounded h-24 overflow-y-auto text-sm"></ul>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t text-center">
                    <button onclick="closeModal()" class="bg-slate-800 text-white px-8 py-2 rounded-lg font-bold">完成並套用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 工具欄 -->
    <div class="max-w-[1000px] mx-auto mb-4 no-print flex flex-wrap justify-between items-center bg-white p-4 rounded-lg shadow-sm gap-2">
        <h1 class="font-bold text-lg flex items-center gap-2">
            <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-sm">正式版</span> 
            生產記錄系統
        </h1>
        <div class="flex gap-2">
            <button onclick="openModal()" class="border border-slate-300 px-4 py-1.5 rounded-lg text-sm hover:bg-slate-50">設定選單</button>
            <button onclick="window.print()" class="bg-blue-600 text-white px-5 py-1.5 rounded-lg text-sm font-bold shadow-md hover:bg-blue-700">列印報表 (PDF)</button>
            <button onclick="confirmClear()" class="text-red-500 text-sm px-2">清空</button>
        </div>
    </div>

    <!-- 報表容器 -->
    <div id="pagesContainer"></div>

    <script>
        let config = JSON.parse(localStorage.getItem('formConfig')) || {
            staff: ["王小明", "李大華"],
            yarn: ["代號A", "代號B"],
            breakReason: ["斷頭", "飄絲", "毛羽"],
            emptyReason: ["機械故障", "缺料", "保養"],
            status: ["", "O", "X"]
        };

        function openModal() { document.getElementById('settingsModal').style.display = 'block'; }
        function closeModal() { document.getElementById('settingsModal').style.display = 'none'; }

        function addItem(type) {
            const input = document.getElementById(`new_${type}`);
            if (input.value.trim()) {
                config[type].push(input.value.trim());
                input.value = '';
                saveConfig();
            }
        }

        function removeItem(type, index) {
            config[type].splice(index, 1);
            saveConfig();
        }

        function saveConfig() {
            localStorage.setItem('formConfig', JSON.stringify(config));
            renderAllPages();
            renderConfigLists();
        }

        function renderConfigLists() {
            ['staff', 'yarn', 'breakReason', 'emptyReason'].forEach(type => {
                const ul = document.getElementById(`list_${type}`);
                if (!ul) return;
                ul.innerHTML = config[type].map((item, index) => `
                    <li class="flex justify-between items-center px-3 py-1.5 border-b last:border-0">
                        <span>${item}</span>
                        <button onclick="removeItem('${type}', ${index})" class="text-red-400 hover:text-red-600">&times;</button>
                    </li>
                `).join('');
            });
        }

        function createPageHTML(pageNum, startIdx, endIdx) {
            return `
                <div class="page-break relative-container">
                    <div class="page-watermark">第 ${pageNum} 頁</div>
                    
                    <!-- 頂部區塊 1 -->
                    <table class="report-table mb-[-1px]">
                        <tr>
                            <td class="w-[18%] label-bg border-b-0">機台-落絲號</td>
                            <td class="w-[12%] label-bg">項目</td>
                            <td class="w-[20%] label-bg">滿管</td>
                            <td class="w-[20%] label-bg">未滿管</td>
                            <td class="w-[15%] label-bg">空錠</td>
                            <td class="w-[15%] label-bg border-b-0">錠位範圍</td>
                        </tr>
                        <tr>
                            <td class="border-t-0"><input type="text" class="cell-input font-bold" placeholder=""></td>
                            <td class="label-bg">代號</td>
                            <td><input type="text" class="cell-input"></td>
                            <td class="font-bold text-red-600 text-lg">O</td>
                            <td class="font-bold text-slate-400 text-lg">X</td>
                            <td class="bg-gray-50 font-medium border-t-0">${startIdx}~${endIdx}</td>
                        </tr>
                        <tr>
                            <td class="label-bg font-bold border-b-0">昇絲人員</td>
                            <td class="label-bg">落絲數</td>
                            <td rowspan="2"></td>
                            <td rowspan="2"></td>
                            <td rowspan="2"></td>
                            <td rowspan="2" class="border-t-0"></td>
                        </tr>
                        <tr>
                            <td class="border-t-0">
                                <select class="cell-input dropdown-staff text-center font-bold w-full h-full"></select>
                            </td>
                            <td class="bg-white"></td>
                        </tr>
                    </table>

                    <!-- 頂部區塊 2 -->
                    <table class="report-table mb-4">
                        <tr class="label-bg">
                            <td>管紗代號</td>
                            <td>試驗卡別</td>
                            <td>紡織班別</td>
                            <td>中檢班別</td>
                            <td>掛絲數量</td>
                            <td>落絲數量</td>
                        </tr>
                        <tr>
                            <td><select class="cell-input dropdown-yarn"></select></td>
                            <td>
                                <select class="cell-input">
                                    <option></option><option>一般</option><option>急件</option><option>測試</option>
                                </select>
                            </td>
                            <td>
                                <select class="cell-input">
                                    <option></option><option>甲</option><option>乙</option><option>丙</option>
                                </select>
                            </td>
                            <td><input type="text" class="cell-input"></td>
                            <td><input type="text" class="cell-input"></td>
                            <td><input type="text" class="cell-input"></td>
                        </tr>
                    </table>

                    <!-- 明細表 -->
                    <table class="report-table">
                        <thead>
                            <tr class="label-bg">
                                <th class="w-[10%]">錠位</th>
                                <th class="w-[15%]">非滿管 O、空錠 X</th>
                                <th class="w-[10%]">紡位</th>
                                <th class="w-[15%]">米長</th>
                                <th class="text-left-cell">斷絲、空錠原因</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody_${pageNum}"></tbody>
                    </table>
                    
                    <div class="mt-4 text-right text-xs text-slate-400 no-print">
                        製表日期：${new Date().toLocaleDateString()}
                    </div>
                </div>
            `;
        }

        function renderAllPages() {
            const container = document.getElementById('pagesContainer');
            container.innerHTML = '';
            
            const pageRanges = [
                { p: 1, s: 1, e: 24 },
                { p: 2, s: 25, e: 48 },
                { p: 3, s: 49, e: 72 },
                { p: 4, s: 73, e: 96 }
            ];

            pageRanges.forEach(range => {
                container.innerHTML += createPageHTML(range.p, range.s, range.e);
                const tbody = document.getElementById(`tableBody_${range.p}`);
                
                for (let i = range.s; i <= range.e; i++) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="label-bg font-bold text-slate-600">${i}</td>
                        <td>
                            <select class="cell-input status-select font-bold" onchange="handleStatusChange(this)">
                                ${config.status.map(v => `<option value="${v}">${v}</option>`).join('')}
                            </select>
                        </td>
                        <td><input type="text" class="cell-input"></td>
                        <td><input type="text" class="cell-input"></td>
                        <td class="text-left-cell">
                            <select class="cell-input text-left-cell reason-select"></select>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            document.querySelectorAll('.dropdown-staff').forEach(s => updateSelect(s, config.staff));
            document.querySelectorAll('.dropdown-yarn').forEach(s => updateSelect(s, config.yarn));
        }

        function handleStatusChange(statusSelect) {
            const row = statusSelect.closest('tr');
            const reasonSelect = row.querySelector('.reason-select');
            const status = statusSelect.value;
            
            let options = ['<option value=""></option>'];
            let list = (status === 'O') ? config.breakReason : (status === 'X' ? config.emptyReason : []);
            list.forEach(r => options.push(`<option value="${r}">${r}</option>`));
            
            reasonSelect.innerHTML = options.join('');
            
            if (status === 'O') statusSelect.style.color = '#ef4444';
            else if (status === 'X') statusSelect.style.color = '#94a3b8';
            else statusSelect.style.color = '#000';
        }

        function updateSelect(el, items) {
            const currentVal = el.value;
            el.innerHTML = '<option value=""></option>' + items.map(item => `<option value="${item}" ${item === currentVal ? 'selected' : ''}>${item}</option>`).join('');
        }

        function confirmClear() {
            if (confirm('確定清空所有數據嗎？')) {
                renderAllPages();
            }
        }

        renderConfigLists();
        renderAllPages();
    </script>
</body>
</html>
