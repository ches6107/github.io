<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生產記錄管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: "Inter", "Noto Sans TC", "微軟正黑體", sans-serif; 
            background-color: #f1f5f9;
            color: #1e293b;
        }
        
        .page-container {
            background: white;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 1000px;
            margin: 0 auto 30px auto;
            min-height: 1050px;
            page-break-after: always;
            position: relative;
            border-radius: 8px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            border: 1.5px solid #000;
            background: white;
            table-layout: fixed;
        }
        
        .report-table th, .report-table td {
            border: 1px solid #000;
            height: 32px;
            padding: 0;
            vertical-align: middle;
            text-align: center;
            font-size: 13px;
        }

        .label-bg { background-color: #f8fafc; font-weight: 600; }

        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            text-align: center;
            font-size: 14px;
            background: transparent;
            padding: 2px;
        }

        .cell-input:focus { background-color: #fffbeb; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page-container {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
                max-width: none;
                border-radius: 0;
            }
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 100px;
            color: rgba(0, 0, 0, 0.02);
            pointer-events: none;
            white-space: nowrap;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-2 sm:p-6">

    <!-- 選單設定彈窗 -->
    <div id="settingsModal" class="no-print" style="display: none;">
        <div class="fixed inset-0 bg-slate-900/60 z-[1000] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden border border-slate-200">
                <div class="p-5 border-b flex justify-between items-center bg-slate-50">
                    <div>
                        <h2 class="font-bold text-xl text-slate-800">選單資料庫管理</h2>
                        <p class="text-xs text-slate-500 mt-1">此處修改的選項將套用到所有機台</p>
                    </div>
                    <button onclick="closeModal()" class="text-3xl hover:text-red-500 transition-colors">&times;</button>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-4 gap-6 max-h-[65vh] overflow-y-auto">
                    <!-- 人員列表 -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-blue-600 uppercase">昇絲人員</label>
                        <div class="flex gap-1"><input type="text" id="new_staff" class="border flex-1 px-2 py-1.5 rounded text-sm"><button onclick="addItem('staff')" class="bg-blue-600 text-white px-3 rounded">+</button></div>
                        <ul id="list_staff" class="border rounded-lg h-44 overflow-y-auto text-sm bg-slate-50 shadow-inner"></ul>
                    </div>
                    <!-- 管紗代號 -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-indigo-600 uppercase">管紗代號</label>
                        <div class="flex gap-1"><input type="text" id="new_yarn" class="border flex-1 px-2 py-1.5 rounded text-sm"><button onclick="addItem('yarn')" class="bg-indigo-600 text-white px-3 rounded">+</button></div>
                        <ul id="list_yarn" class="border rounded-lg h-44 overflow-y-auto text-sm bg-slate-50 shadow-inner"></ul>
                    </div>
                    <!-- 試驗卡別 -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-cyan-600 uppercase">試驗卡別</label>
                        <div class="flex gap-1"><input type="text" id="new_testCard" class="border flex-1 px-2 py-1.5 rounded text-sm"><button onclick="addItem('testCard')" class="bg-cyan-600 text-white px-3 rounded">+</button></div>
                        <ul id="list_testCard" class="border rounded-lg h-44 overflow-y-auto text-sm bg-slate-50 shadow-inner"></ul>
                    </div>
                    <!-- 斷絲原因 -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-red-500 uppercase">斷絲原因 (O)</label>
                        <div class="flex gap-1"><input type="text" id="new_breakReason" class="border flex-1 px-2 py-1.5 rounded text-sm"><button onclick="addItem('breakReason')" class="bg-red-600 text-white px-3 rounded">+</button></div>
                        <ul id="list_breakReason" class="border rounded-lg h-44 overflow-y-auto text-sm bg-slate-50 shadow-inner"></ul>
                    </div>
                    <!-- 空錠原因 -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">空錠原因 (X)</label>
                        <div class="flex gap-1"><input type="text" id="new_emptyReason" class="border flex-1 px-2 py-1.5 rounded text-sm"><button onclick="addItem('emptyReason')" class="bg-slate-700 text-white px-3 rounded">+</button></div>
                        <ul id="list_emptyReason" class="border rounded-lg h-44 overflow-y-auto text-sm bg-slate-50 shadow-inner"></ul>
                    </div>
                    <!-- 班別選項 -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-emerald-600 uppercase">班別選項</label>
                        <div class="flex gap-1"><input type="text" id="new_shift" class="border flex-1 px-2 py-1.5 rounded text-sm"><button onclick="addItem('shift')" class="bg-emerald-600 text-white px-3 rounded">+</button></div>
                        <ul id="list_shift" class="border rounded-lg h-44 overflow-y-auto text-sm bg-slate-50 shadow-inner"></ul>
                    </div>
                    <!-- 狀態選項 -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-orange-600 uppercase">狀態欄代號</label>
                        <div class="flex gap-1"><input type="text" id="new_statusTags" class="border flex-1 px-2 py-1.5 rounded text-sm"><button onclick="addItem('statusTags')" class="bg-orange-600 text-white px-3 rounded">+</button></div>
                        <ul id="list_statusTags" class="border rounded-lg h-44 overflow-y-auto text-sm bg-slate-50 shadow-inner"></ul>
                    </div>
                </div>
                <div class="p-5 bg-slate-50 border-t flex justify-center gap-4">
                    <button onclick="closeModal()" class="bg-slate-800 text-white px-10 py-2.5 rounded-xl font-bold hover:bg-slate-900 shadow-lg transition-all active:scale-95">完成設定並返回</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 頂部控制列 -->
    <div class="max-w-[1000px] mx-auto mb-6 no-print flex flex-wrap justify-between items-center bg-white p-5 rounded-xl shadow-sm gap-4 border border-slate-200">
        
        <div class="flex items-center gap-3">
            <div class="flex flex-col">
                <span class="text-[10px] font-black text-slate-400 uppercase ml-1 mb-1">機台選擇</span>
                <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg border border-slate-200">
                    <select id="machineSelector" onchange="switchMachine(this.value)" class="bg-transparent px-3 py-1.5 text-sm font-bold text-slate-700 outline-none min-w-[100px]">
                    </select>
                    <button onclick="addNewMachine()" class="bg-white text-blue-600 w-8 h-8 rounded-md shadow-sm hover:bg-blue-600 hover:text-white transition-all font-bold" title="新增機台">+</button>
                    <button id="delMachineBtn" onclick="deleteCurrentMachine()" class="bg-white text-red-500 w-8 h-8 rounded-md shadow-sm hover:bg-red-500 hover:text-white transition-all font-bold" title="刪除當前機台">×</button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="openModal()" class="bg-white border border-slate-300 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-50 transition-all">編輯選項清單</button>
            <button onclick="window.print()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-md hover:bg-blue-700 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5z"/></svg>
                列印報表
            </button>
        </div>
    </div>

    <!-- 報表主體 -->
    <div id="pagesContainer"></div>

    <script>
        // --- 1. 資料初始化 (根據圖片更新預設值) ---
        const STORAGE_KEY = 'PROD_SYSTEM_STATE_V2';

        const defaultConfig = {
            staff: [
                "C/瑪菈", "C/潘妮達", "C/安恰麗", "C/潘娣", "C/蒂帕灣", "C/佩娃", "C/凱魯納",
                "A/林宜安", "A/陳美麗", "A/洪子惠", "A/阿娜", "A/妮達雅", "A/芭莉恰", "A/蘇西", "A/阿雅", "A/蘇帕嵐",
                "B/周嘉玟", "B/劉漆琦", "B/安琪琳", "B/阿蓉功", "B/馬妮拉", "B/歐拉莎", "B/萍品茶", "B/梯達拉"
            ],
            yarn: ["T1D1T", "T1D1U", "T1D1A", "T1D5C", "T1D5U", "TEE2K", "T2D5R", "T2D1M", "TMD4A", "TMD4D"],
            testCard: ["無", "白", "紫", "黃黑", "紫白", "白藍", "橘", "黃", "紅", "粉紅", "紅綠"],
            breakReason: [
                "毛破", "毛破IP", "毛破IP (細)", "IP", "反捲", "反捲IP", "無管底紗", "無絲頭", 
                "單關巡(夾紗)", "單關巡(凹陷)", "單關巡(凸緣)", "單關巡(管傷)", "絲束正常", "夾紗", "夾廢絲", "鄰錠波及", "撞傷"
            ],
            emptyReason: ["無絲頭", "反捲", "漿疤", "氣泡數降A2", "中層紗", "異常卡", "跳停", "單關巡(管傷)"],
            shift: ["A", "B", "C"],
            statusTags: ["CD", "BO", "TTS"],
            status: ["", "O", "X"]
        };

        let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            activeId: 'm-1',
            machines: [{ id: 'm-1', name: '機台 A', data: { p1_range: '1-24', p3_range: '49-72' } }],
            config: JSON.parse(JSON.stringify(defaultConfig))
        };

        // --- 2. 存儲與連動邏輯 ---

        function saveState() {
            const machine = state.machines.find(m => m.id === state.activeId);
            if (machine) {
                machine.data = machine.data || {};
                document.querySelectorAll('[data-field]').forEach(el => {
                    machine.data[el.getAttribute('data-field')] = el.value;
                });
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function handleStaffSync(val) {
            document.querySelectorAll('[data-field^="staff_"]').forEach(el => {
                el.value = val;
            });
            saveState();
        }

        // --- 3. 機台管理 ---

        function renderMachineSelector() {
            const selector = document.getElementById('machineSelector');
            selector.innerHTML = state.machines.map(m => `
                <option value="${m.id}" ${m.id === state.activeId ? 'selected' : ''}>${m.name}</option>
            `).join('');
            document.getElementById('delMachineBtn').style.display = state.machines.length > 1 ? 'block' : 'none';
        }

        function switchMachine(id) {
            saveState();
            state.activeId = id;
            renderMachineSelector();
            renderAllPages();
        }

        function addNewMachine() {
            const name = prompt("輸入新機台名稱:");
            if (!name) return;
            
            saveState();
            const newId = 'm-' + Date.now();
            
            // 重要：明確初始化一個完全乾淨的資料物件
            const emptyData = { 
                p1_range: '1-24', 
                p3_range: '49-72' 
            };
            
            state.machines.push({ 
                id: newId, 
                name: name, 
                data: emptyData 
            });
            
            state.activeId = newId;
            saveState();
            renderMachineSelector();
            renderAllPages();
        }

        function deleteCurrentMachine() {
            if (state.machines.length <= 1) return;
            if (!confirm("確定刪除此機台所有資料？")) return;
            state.machines = state.machines.filter(m => m.id !== state.activeId);
            state.activeId = state.machines[0].id;
            saveState();
            renderMachineSelector();
            renderAllPages();
        }

        // --- 4. 頁面渲染 ---

        function renderAllPages() {
            const container = document.getElementById('pagesContainer');
            const machine = state.machines.find(m => m.id === state.activeId);
            // 確保資料存在，如果不存在則給予空物件
            const mData = machine.data || {};

            const range1 = mData.p1_range || "1-24";
            const range3 = mData.p3_range || "49-72";

            let html = '';
            const pageConfigs = [];
            
            if (range1 === "1-48") pageConfigs.push({ id: 1, start: 1, end: 48, rType: 'p1', canChange: true });
            else { pageConfigs.push({ id: 1, start: 1, end: 24, rType: 'p1', canChange: true }); pageConfigs.push({ id: 2, start: 25, end: 48 }); }
            
            if (range3 === "49-96") pageConfigs.push({ id: 3, start: 49, end: 96, rType: 'p3', canChange: true });
            else { pageConfigs.push({ id: 3, start: 49, end: 72, rType: 'p3', canChange: true }); pageConfigs.push({ id: 4, start: 73, end: 96 }); }

            pageConfigs.forEach(pg => {
                const count = pg.end - pg.start + 1;
                // 讀取當前機台特定頁面的昇絲人員
                const currentStaff = mData[`staff_${pg.id}`] || '';

                html += `
                <div class="page-container">
                    <div class="watermark no-print">PAGE ${pg.id}</div>
                    
                    <table class="report-table mb-[-1px]">
                        <tr>
                            <td class="w-[18%] label-bg">機台名稱</td><td class="w-[12%] label-bg">項目</td>
                            <td class="w-[20%] label-bg">滿管</td><td class="w-[20%] label-bg">未滿管</td>
                            <td class="w-[15%] label-bg">空錠</td><td class="w-[15%] label-bg">錠位範圍</td>
                        </tr>
                        <tr>
                            <td class="font-bold text-blue-700">${machine.name}</td>
                            <td class="label-bg">代號</td>
                            <td><input type="text" class="cell-input" data-field="code_${pg.id}" value="${mData['code_'+pg.id] || ''}"></td>
                            <td class="font-bold text-red-600">O</td><td class="font-bold text-slate-400">X</td>
                            <td class="p-0">
                                ${pg.canChange ? `
                                    <select class="cell-input font-bold text-blue-600" data-field="${pg.rType}_range" onchange="saveState(); renderAllPages();">
                                        ${pg.rType === 'p1' ? `<option value="1-24" ${range1==='1-24'?'selected':''}>1-24</option><option value="1-48" ${range1==='1-48'?'selected':''}>1-48</option>` :
                                        `<option value="49-72" ${range3==='49-72'?'selected':''}>49-72</option><option value="49-96" ${range3==='49-96'?'selected':''}>49-96</option>`}
                                    </select>
                                ` : `<div class="bg-slate-50 font-bold h-full flex items-center justify-center">${pg.start}-${pg.end}</div>`}
                            </td>
                        </tr>
                        <tr>
                            <td class="label-bg">昇絲人員</td><td class="label-bg" rowspan="2">落絲數</td>
                            <td rowspan="2"><input type="text" class="cell-input" data-field="f_${pg.id}" value="${mData['f_'+pg.id]||''}"></td>
                            <td rowspan="2"><input type="text" class="cell-input" data-field="n_${pg.id}" value="${mData['n_'+pg.id]||''}"></td>
                            <td rowspan="2"><input type="text" class="cell-input" data-field="e_${pg.id}" value="${mData['e_'+pg.id]||''}"></td>
                            <td rowspan="2" class="bg-slate-50"></td>
                        </tr>
                        <tr>
                            <td>
                                <select class="cell-input font-bold" data-field="staff_${pg.id}" onchange="handleStaffSync(this.value)">
                                    <option></option>
                                    ${state.config.staff.map(s => `<option value="${s}" ${currentStaff===s?'selected':''}>${s}</option>`).join('')}
                                </select>
                            </td>
                        </tr>
                    </table>

                    <table class="report-table mb-4">
                        <tr class="label-bg text-[11px]">
                            <td>管紗代號</td><td>試驗卡別</td><td>狀態</td><td>紡織班</td><td>中檢班</td><td>掛絲數</td><td>落絲數</td>
                        </tr>
                        <tr>
                            <td><select class="cell-input" data-field="y_${pg.id}">${genOpts('yarn', mData['y_'+pg.id])}</select></td>
                            <td><select class="cell-input" data-field="tc_${pg.id}">${genOpts('testCard', mData['tc_'+pg.id])}</select></td>
                            <td><select class="cell-input" data-field="st_${pg.id}">${genOpts('statusTags', mData['st_'+pg.id])}</select></td>
                            <td><select class="cell-input" data-field="ws_${pg.id}">${genOpts('shift', mData['ws_'+pg.id])}</select></td>
                            <td><select class="cell-input" data-field="cs_${pg.id}">${genOpts('shift', mData['cs_'+pg.id])}</select></td>
                            <td><input type="text" class="cell-input" data-field="hq_${pg.id}" value="${mData['hq_'+pg.id]||''}"></td>
                            <td><input type="text" class="cell-input" data-field="dq_${pg.id}" value="${mData['dq_'+pg.id]||''}"></td>
                        </tr>
                    </table>

                    <table class="report-table">
                        <thead class="label-bg">
                            <tr><th class="w-[10%]">錠位</th><th class="w-[15%]">狀態</th><th class="w-[10%]">紡位</th><th class="w-[15%]">米長</th><th class="text-left px-2">原因</th></tr>
                        </thead>
                        <tbody>
                            ${Array.from({length: count}, (_, i) => pg.start + i).map(idx => `
                                <tr>
                                    <td class="label-bg font-mono text-slate-400">${idx}</td>
                                    <td>
                                        <select class="cell-input font-bold status-trigger" data-field="r_${idx}_s" onchange="updateReasonCell(this, ${idx})">
                                            ${state.config.status.map(v => `<option value="${v}" ${mData[`r_${idx}_s`] === v ? 'selected' : ''}>${v}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td><input type="text" class="cell-input" data-field="r_${idx}_p" value="${mData[`r_${idx}_p`] || ''}"></td>
                                    <td><input type="text" class="cell-input" data-field="r_${idx}_l" value="${mData[`r_${idx}_l`] || ''}"></td>
                                    <td class="text-left px-1"><select class="cell-input text-left reason-box" data-field="r_${idx}_r"></select></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            });

            container.innerHTML = html;
            
            // 初始化原因下拉選單的選項
            document.querySelectorAll('.status-trigger').forEach(el => {
                const idx = el.getAttribute('data-field').split('_')[1];
                updateReasonCell(el, idx, false);
            });

            // 監聽所有輸入欄位變更
            container.querySelectorAll('input, select').forEach(el => {
                if (!el.getAttribute('data-field').startsWith('staff_')) {
                    el.addEventListener('change', saveState);
                    el.addEventListener('input', saveState);
                }
            });
        }

        function genOpts(type, selected) {
            return '<option></option>' + state.config[type].map(v => `<option value="${v}" ${selected === v ? 'selected' : ''}>${v}</option>`).join('');
        }

        function updateReasonCell(statusEl, idx, triggerSave = true) {
            const row = statusEl.closest('tr');
            const reasonSelect = row.querySelector('.reason-box');
            const status = statusEl.value;
            const machine = state.machines.find(m => m.id === state.activeId);
            const savedReason = (machine.data && machine.data[`r_${idx}_r`]) || '';
            
            let list = [];
            if (status === 'O') { 
                list = state.config.breakReason; 
                statusEl.style.color = '#ef4444'; 
            } else if (status === 'X') { 
                list = state.config.emptyReason; 
                statusEl.style.color = '#64748b'; 
            } else {
                statusEl.style.color = '#000';
            }

            reasonSelect.innerHTML = '<option></option>' + list.map(r => `<option value="${r}" ${savedReason === r ? 'selected' : ''}>${r}</option>`).join('');
            if (triggerSave) saveState();
        }

        // --- 5. 設定管理 ---

        function openModal() { renderConfigUI(); document.getElementById('settingsModal').style.display = 'block'; }
        function closeModal() { document.getElementById('settingsModal').style.display = 'none'; renderAllPages(); }
        
        function addItem(type) {
            const input = document.getElementById(`new_${type}`);
            const val = input.value.trim();
            if (val && !state.config[type].includes(val)) {
                state.config[type].push(val);
                input.value = '';
                saveState();
                renderConfigUI();
            }
        }

        function removeItem(type, idx) {
            state.config[type].splice(idx, 1);
            saveState();
            renderConfigUI();
        }

        function renderConfigUI() {
            ['staff', 'yarn', 'testCard', 'breakReason', 'emptyReason', 'shift', 'statusTags'].forEach(type => {
                const ul = document.getElementById(`list_${type}`);
                if (!ul) return;
                ul.innerHTML = state.config[type].map((item, i) => `
                    <li class="flex justify-between items-center px-3 py-2 border-b border-slate-100 hover:bg-white text-sm">
                        <span>${item}</span>
                        <button onclick="removeItem('${type}', ${i})" class="text-red-400 hover:text-red-600 font-bold">×</button>
                    </li>
                `).join('');
            });
        }

        window.onload = () => { renderMachineSelector(); renderAllPages(); };
    </script>
</body>
</html>
