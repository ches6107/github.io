<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿç”¢ç´€éŒ„ç³»çµ± - å®Œæ•´åŒæ­¥ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        @media print { .no-print { display: none !important; } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- é…ç½®èˆ‡å¸¸æ•¸ ---
        const firebaseConfig = { apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: "" };
        const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        
        // ç¢ºä¿åªåˆå§‹åŒ–ä¸€æ¬¡
        if (!firebase.apps.length) {
            firebase.initializeApp(config);
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'production-record-v1';

        const FIXED_RANGES = ['1-24', '25-48', '49-72', '73-96', '1-48', '49-96'];
        const UNIT_IDS = ['1', '2', '3', '4'];
        const PAGES = Array.from({ length: 10 }, (_, i) => (i + 1).toString());

        const getDefaultRange = (id) => {
            if (id === '1') return '1-24';
            if (id === '2') return '25-48';
            if (id === '3') return '49-72';
            if (id === '4') return '73-96';
            return '1-48';
        };

        const getEmptyGroup = (id) => ({
            header: { doffFull: '', doffNotFull: '', doffEmpty: '', doffRange: getDefaultRange(id) },
            batch: { tubeCode: '', testCard: '', cdBoTts: '', spinShift: '', inspShift: '', hangCount: '', doffQty: '' },
            rows: {}
        });

        // --- å­çµ„ä»¶ï¼šæ©Ÿå™¨å–®å…ƒ ---
        const MachineUnit = ({ id, groupData, sharedHeader, options, onUpdate, onSharedUpdate }) => {
            if (!groupData) return null;
            const rangeStr = groupData.header.doffRange || getDefaultRange(id);
            const match = rangeStr.match(/(\d+)[-~](\d+)/);
            const start = match ? parseInt(match[1]) : 1;
            const end = match ? parseInt(match[2]) : 48;
            const count = end - start + 1;

            const updateH = (f, v) => onUpdate(id, { ...groupData, header: { ...groupData.header, [f]: v } });
            const updateB = (f, v) => onUpdate(id, { ...groupData, batch: { ...groupData.batch, [f]: v } });
            
            const updateR = (idx, f, v) => {
                const newData = { ...groupData };
                if (!newData.rows) newData.rows = {};
                if (!newData.rows[rangeStr]) newData.rows[rangeStr] = [];
                const rows = [...newData.rows[rangeStr]];
                while (rows.length <= idx) rows.push({ status: '', spinPos: '', length: '', reason: '' });
                rows[idx] = { ...rows[idx], [f]: v };
                if (f === 'status') rows[idx].reason = '';
                newData.rows[rangeStr] = rows;
                onUpdate(id, newData);
            };

            const displayRows = Array.from({ length: count }, (_, i) => {
                const r = (groupData.rows[rangeStr] || [])[i] || { status: '', spinPos: '', length: '', reason: '' };
                return { id: start + i, index: i, ...r };
            });

            return (
                <div className="bg-white shadow-md rounded-2xl mb-8 border-l-4 border-blue-600 overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <h3 className="text-xl font-black text-slate-700">å–®å…ƒ {id}</h3>
                        <span className="text-xs font-bold text-slate-400">ç¯„åœ: {rangeStr}</span>
                    </div>
                    
                    <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-b">
                        <div className="space-y-2">
                            <label className="text-[10px] font-bold text-blue-600">æ©Ÿå°/äººå“¡</label>
                            <div className="flex gap-2">
                                <input placeholder="æ©Ÿå°è™Ÿ" className="w-1/2 p-2 border rounded bg-blue-50/30" value={sharedHeader.machineNo} onChange={e => onSharedUpdate('machineNo', e.target.value)} />
                                <select className="w-1/2 p-2 border rounded" value={sharedHeader.personnel} onChange={e => onSharedUpdate('personnel', e.target.value)}>
                                    <option value="">äººå“¡</option>
                                    {options.personnel.map(o => <option key={o} value={o}>{o}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="md:col-span-2 grid grid-cols-4 gap-2">
                            <div><label className="text-[10px] font-bold text-gray-400">æ»¿ç®¡</label><input className="w-full p-2 border rounded" value={groupData.header.doffFull} onChange={e => updateH('doffFull', e.target.value)} /></div>
                            <div><label className="text-[10px] font-bold text-gray-400">æœªæ»¿</label><input className="w-full p-2 border rounded" value={groupData.header.doffNotFull} onChange={e => updateH('doffNotFull', e.target.value)} /></div>
                            <div><label className="text-[10px] font-bold text-gray-400">ç©ºç®¡</label><input className="w-full p-2 border rounded" value={groupData.header.doffEmpty} onChange={e => updateH('doffEmpty', e.target.value)} /></div>
                            <div><label className="text-[10px] font-bold text-blue-600">è¨­å®šç¯„åœ</label>
                                <select className="w-full p-2 border rounded bg-blue-50/50" value={rangeStr} onChange={e => updateH('doffRange', e.target.value)}>
                                    {FIXED_RANGES.map(r => <option key={r} value={r}>{r}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 overflow-x-auto">
                        <table className="w-full text-xs text-center border">
                            <thead className="bg-slate-100">
                                <tr>
                                    <th className="p-2 border">ç®¡ç´—</th><th className="p-2 border">è©¦é©—å¡</th>
                                    <th className="p-2 border">é¡å‹</th><th className="p-2 border">ç´¡/æª¢ç­</th>
                                    <th className="p-2 border">æ›çµ²/è½çµ²</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td className="p-1 border"><input className="w-full text-center" value={groupData.batch.tubeCode} onChange={e => updateB('tubeCode', e.target.value)} /></td>
                                    <td className="p-1 border"><input className="w-full text-center" value={groupData.batch.testCard} onChange={e => updateB('testCard', e.target.value)} /></td>
                                    <td className="p-1 border"><select className="w-full" value={groupData.batch.cdBoTts} onChange={e => updateB('cdBoTts', e.target.value)}><option value="">-</option>{options.cdBoTts.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
                                    <td className="p-1 border flex">
                                        <input className="w-1/2 text-center border-r" value={groupData.batch.spinShift} onChange={e => updateB('spinShift', e.target.value)} />
                                        <input className="w-1/2 text-center" value={groupData.batch.inspShift} onChange={e => updateB('inspShift', e.target.value)} />
                                    </td>
                                    <td className="p-1 border">
                                        <input className="w-1/2 text-center border-r" value={groupData.batch.hangCount} onChange={e => updateB('hangCount', e.target.value)} />
                                        <input className="w-1/2 text-center font-bold text-blue-600" value={groupData.batch.doffQty} onChange={e => updateB('doffQty', e.target.value)} />
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div className="mx-4 mb-4 border rounded overflow-hidden">
                        <div className="grid grid-cols-12 bg-slate-800 text-white text-[10px] py-1 text-center font-bold">
                            <div className="col-span-1">éŒ </div><div className="col-span-2">ç‹€æ…‹</div><div className="col-span-2">ç´¡ä½</div><div className="col-span-2">ç±³é•·</div><div className="col-span-5">åŸå› èªªæ˜</div>
                        </div>
                        <div className="max-h-60 overflow-y-auto custom-scroll">
                            {displayRows.map(r => (
                                <div key={r.id} className="grid grid-cols-12 border-t text-xs h-8 items-center text-center">
                                    <div className="col-span-1 bg-slate-50 font-bold border-r h-full flex items-center justify-center">{r.id}</div>
                                    <div className="col-span-2 border-r h-full">
                                        <select className="w-full h-full outline-none" value={r.status} onChange={e => updateR(r.index, 'status', e.target.value)}>
                                            <option value="">-</option><option value="O">O (æ–·)</option><option value="X">X (ç©º)</option>
                                        </select>
                                    </div>
                                    <div className="col-span-2 border-r h-full"><input className="w-full h-full text-center" value={r.spinPos} onChange={e => updateR(r.index, 'spinPos', e.target.value)} /></div>
                                    <div className="col-span-2 border-r h-full"><input className="w-full h-full text-center" value={r.length} onChange={e => updateR(r.index, 'length', e.target.value)} /></div>
                                    <div className="col-span-5 h-full">
                                        <select className="w-full h-full text-[10px] px-1" value={r.reason} onChange={e => updateR(r.index, 'reason', e.target.value)}>
                                            <option value="">é¸æ“‡åŸå› ...</option>
                                            {(r.status === 'O' ? options.breakReason : (r.status === 'X' ? options.emptyReason : [])).map(o => <option key={o} value={o}>{o}</option>)}
                                        </select>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä¸»ç¨‹å¼ ---
        function App() {
            const [user, setUser] = useState(null);
            const [activePage, setActivePage] = useState('1');
            const [allGroups, setAllGroups] = useState({});
            const [sharedHeader, setSharedHeader] = useState({ machineNo: '', personnel: '' });
            const [saveStatus, setSaveStatus] = useState('idle');

            const options = {
                personnel: ['ç®¡ç†å“¡', 'é ˜ç­', 'æ“ä½œå“¡'],
                cdBoTts: ['CD', 'BO', 'TTS'],
                breakReason: ['åŸç´—æ–·', 'ç¹è»¸', 'äººç‚º', 'æ©Ÿæ¢°'],
                emptyReason: ['ç¶­ä¿®', 'æ¸…æ½”', 'å¾…æ–™']
            };

            // è™•ç†ç™»å…¥
            useEffect(() => {
                const login = async () => {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' && __initial_auth_token ? __initial_auth_token : null;
                        if (token) {
                            await auth.signInWithCustomToken(token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { 
                        console.error("Auth Error:", e); 
                    }
                };
                login();
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // ç›£è½è³‡æ–™
            useEffect(() => {
                if (!user) return;
                
                // ä¿®æ­£è·¯å¾‘ç¢ºä¿ç¬¦åˆ Rule 1
                const path = `artifacts/${appId}/public/data/pages/page_${activePage}`;
                
                const unsubscribe = db.doc(path).onSnapshot(snap => {
                    // ä¿®æ­£é—œéµéŒ¯èª¤ï¼šåœ¨ compat ç‰ˆæœ¬ä¸­ snap.exists æ˜¯ä¸€å€‹å±¬æ€§ï¼Œæœ‰æ™‚åœ¨æŸäº›ç’°å¢ƒä¸‹ snap ç‰©ä»¶çµæ§‹ä¸åŒ
                    const exists = typeof snap.exists === 'function' ? snap.exists() : snap.exists;
                    
                    if (exists) {
                        const d = snap.data();
                        setAllGroups(d.allGroups || {});
                        setSharedHeader(d.sharedHeader || { machineNo: '', personnel: '' });
                    } else {
                        const init = {}; 
                        UNIT_IDS.forEach(id => init[id] = getEmptyGroup(id));
                        setAllGroups(init);
                        setSharedHeader({ machineNo: '', personnel: '' });
                    }
                }, err => {
                    console.error("Firestore Snapshot Error:", err);
                });
                
                return () => unsubscribe();
            }, [user, activePage]);

            const saveData = useCallback(async (groups, header) => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    await db.doc(`artifacts/${appId}/public/data/pages/page_${activePage}`).set({
                        allGroups: groups || allGroups,
                        sharedHeader: header || sharedHeader,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setSaveStatus('success');
                    setTimeout(() => setSaveStatus('idle'), 2000);
                } catch (e) { 
                    console.error("Save Error:", e);
                    setSaveStatus('error'); 
                }
            }, [user, activePage, allGroups, sharedHeader]);

            const onUpdateGroup = (id, data) => {
                const next = { ...allGroups, [id]: data };
                setAllGroups(next);
                saveData(next, sharedHeader);
            };

            const onUpdateShared = (f, v) => {
                const next = { ...sharedHeader, [f]: v };
                setSharedHeader(next);
                saveData(allGroups, next);
            };

            const clearPage = () => {
                if (window.confirm(`ç¢ºå®šè¦æ¸…ç©ºç¬¬ ${activePage} å·¥ä½œç«™çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ`)) {
                    const init = {}; UNIT_IDS.forEach(id => init[id] = getEmptyGroup(id));
                    setAllGroups(init);
                    setSharedHeader({ machineNo: '', personnel: '' });
                    saveData(init, { machineNo: '', personnel: '' });
                }
            };

            return (
                <div className="max-w-4xl mx-auto p-4 pb-20">
                    <header className="sticky top-0 bg-white/90 backdrop-blur shadow-sm z-50 p-3 rounded-b-2xl mb-6 flex justify-between items-center no-print">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">R</div>
                            <h1 className="font-black text-lg">ç”Ÿç”¢ç´€éŒ„</h1>
                        </div>
                        <div className="flex gap-1 bg-slate-100 p-1 rounded-lg overflow-x-auto max-w-[60%]">
                            {PAGES.map(p => (
                                <button key={p} onClick={() => setActivePage(p)} className={`px-3 py-1 rounded text-sm font-bold transition flex-shrink-0 ${activePage === p ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-white'}`}>
                                    {p}
                                </button>
                            ))}
                        </div>
                    </header>

                    <div className="flex justify-between items-end mb-6 px-2">
                        <div>
                            <h2 className="text-3xl font-black text-slate-800">å·¥ä½œç«™ {activePage}</h2>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                                {!user ? 'âš ï¸ æœªç™»å…¥' : (saveStatus === 'saving' ? 'â˜ï¸ åŒæ­¥ä¸­...' : 'âœ… é›²ç«¯å·²é€£ç·š')}
                            </p>
                        </div>
                        <button onClick={() => window.print()} className="p-2 bg-slate-200 rounded-full hover:bg-slate-300 no-print transition-colors">ğŸ–¨ï¸</button>
                    </div>

                    {UNIT_IDS.map(id => (
                        <MachineUnit 
                            key={`${activePage}-${id}`} id={id}
                            groupData={allGroups[id]} sharedHeader={sharedHeader}
                            options={options} onUpdate={onUpdateGroup} onSharedUpdate={onUpdateShared}
                        />
                    ))}

                    <div className="mt-12 flex flex-col items-center no-print">
                        <button onClick={clearPage} className="bg-red-500 text-white px-8 py-4 rounded-2xl font-black shadow-lg hover:bg-red-600 active:scale-95 transition">
                            ğŸ—‘ï¸ æ¸…ç©ºå·¥ä½œç«™ {activePage} è³‡æ–™
                        </button>
                        <p className="mt-4 text-slate-400 text-xs italic">è³‡æ–™å°‡å³æ™‚å¾è³‡æ–™åº«ä¸­åˆªé™¤</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
