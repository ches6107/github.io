import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { Printer, CheckCircle, X, Layers, Trash2, Settings, ChevronDown } from 'lucide-react';

// --- Firebase 配置 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'production-log-v13';

const FIXED_RANGES = ['1-24', '25-48', '49-72', '73-96', '1-48', '49-96'];
const UNIT_IDS = ['1', '2', '3', '4']; 
const FIXED_PAGE_IDS = Array.from({ length: 10 }, (_, i) => (i + 1).toString());

const getDefaultRangeById = (id) => {
  switch (id) {
    case '1': return '1-24';
    case '2': return '25-48';
    case '3': return '49-72';
    case '4': return '73-96';
    default: return '1-48';
  }
};

const getInitialGroupData = (id) => ({
  header: { doffFull: '', doffNotFull: '', doffEmpty: '', doffRange: getDefaultRangeById(id) },
  batch: { tubeCode: '', testCard: '', cdBoTts: '', spinShift: '', inspShift: '', hangCount: '', doffQty: '' },
  rows: {} 
});

const MachineUnit = ({ id, groupData, sharedHeader, options, onUpdate, onSharedUpdate }) => {
  if (!groupData) return null;

  const rangeStr = groupData.header?.doffRange || getDefaultRangeById(id);
  const match = rangeStr.match(/(\d+)[-~](\d+)/);
  const start = match ? parseInt(match[1]) : 1;
  const end = match ? parseInt(match[2]) : 48;
  const count = end - start + 1;

  const handleHeaderChange = (field, val) => {
    onUpdate(id, { ...groupData, header: { ...groupData.header, [field]: val } });
  };

  const handleBatchChange = (field, val) => {
    onUpdate(id, { ...groupData, batch: { ...groupData.batch, [field]: val } });
  };

  const handleRowChange = (idx, field, val) => {
    const newData = { ...groupData };
    const rangeKey = rangeStr;
    const currentRowsInState = newData.rows?.[rangeKey] || [];
    const updatedRows = [...currentRowsInState];
    
    while (updatedRows.length <= idx) {
      updatedRows.push({ status: '', spinPos: '', length: '', reason: '' });
    }

    if (field === 'status' && updatedRows[idx].status !== val) {
      updatedRows[idx].reason = '';
    }

    updatedRows[idx] = { ...updatedRows[idx], [field]: val };
    if (!newData.rows) newData.rows = {};
    newData.rows[rangeKey] = updatedRows;
    onUpdate(id, newData);
  };

  const currentRowsDisplay = Array.from({ length: count }, (_, i) => {
    const row = (groupData.rows?.[rangeStr] || [])[i] || { status: '', spinPos: '', length: '', reason: '' };
    return { id: start + i, index: i, ...row };
  });

  return (
    <div id={`unit-${id}`} className="bg-white shadow-lg mb-10 p-6 rounded-3xl border-l-8 border-indigo-500 scroll-mt-32">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-3xl font-black text-gray-800">單元 {id}</h2>
        <span className="text-sm font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full">{rangeStr} 錠位</span>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
        <div className="md:col-span-4 grid grid-cols-2 border rounded-xl overflow-hidden shadow-sm">
          <div className="border-r bg-indigo-50/30 p-2">
            <label className="block text-[10px] font-bold text-indigo-600 mb-1">機台-落絲號</label>
            <input type="text" value={sharedHeader.machineNo || ''} onChange={e => onSharedUpdate('machineNo', e.target.value)} className="w-full bg-transparent font-bold outline-none" placeholder="輸入..." />
          </div>
          <div className="bg-indigo-50/30 p-2">
            <label className="block text-[10px] font-bold text-indigo-600 mb-1">昇絲人員</label>
            <select value={sharedHeader.personnel || ''} onChange={e => onSharedUpdate('personnel', e.target.value)} className="w-full bg-transparent font-bold outline-none">
              <option value="">選擇</option>
              {options.personnel?.map(opt => <option key={opt} value={opt}>{opt}</option>)}
            </select>
          </div>
        </div>

        <div className="md:col-span-8 grid grid-cols-4 border rounded-xl overflow-hidden bg-gray-50/30 shadow-sm">
          <div className="border-r p-2">
            <label className="block text-[10px] font-bold text-blue-500">滿管</label>
            <input type="text" value={groupData.header?.doffFull || ''} onChange={e => handleHeaderChange('doffFull', e.target.value)} className="w-full bg-transparent font-bold outline-none" />
          </div>
          <div className="border-r p-2">
            <label className="block text-[10px] font-bold text-orange-500">未滿管</label>
            <input type="text" value={groupData.header?.doffNotFull || ''} onChange={e => handleHeaderChange('doffNotFull', e.target.value)} className="w-full bg-transparent font-bold outline-none" />
          </div>
          <div className="border-r p-2">
            <label className="block text-[10px] font-bold text-red-500">空錠</label>
            <input type="text" value={groupData.header?.doffEmpty || ''} onChange={e => handleHeaderChange('doffEmpty', e.target.value)} className="w-full bg-transparent font-bold outline-none" />
          </div>
          <div className="p-2 bg-indigo-50/50">
            <label className="block text-[10px] font-bold text-indigo-600">範圍</label>
            <select value={groupData.header?.doffRange || getDefaultRangeById(id)} onChange={e => handleHeaderChange('doffRange', e.target.value)} className="w-full bg-transparent font-bold outline-none">
              {FIXED_RANGES.map(opt => <option key={opt} value={opt}>{opt}</option>)}
            </select>
          </div>
        </div>
      </div>

      <div className="overflow-x-auto mb-6">
        <table className="w-full text-xs text-center border rounded-xl overflow-hidden">
          <thead className="bg-gray-100 text-gray-500">
            <tr>
              <th className="p-2 border-r">管紗代號</th>
              <th className="p-2 border-r">試驗卡</th>
              <th className="p-2 border-r">類型</th>
              <th className="p-2 border-r">紡織班別</th>
              <th className="p-2 border-r">中檢班別</th>
              <th className="p-2 border-r">掛絲數</th>
              <th className="p-2">落絲數</th>
            </tr>
          </thead>
          <tbody>
            <tr className="border-t">
              <td className="p-1 border-r"><select className="w-full outline-none" value={groupData.batch?.tubeCode || ''} onChange={e => handleBatchChange('tubeCode', e.target.value)}><option value="">-</option>{options.tube?.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
              <td className="p-1 border-r"><select className="w-full outline-none" value={groupData.batch?.testCard || ''} onChange={e => handleBatchChange('testCard', e.target.value)}><option value="">-</option>{options.testCard?.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
              <td className="p-1 border-r"><select className="w-full outline-none font-bold" value={groupData.batch?.cdBoTts || ''} onChange={e => handleBatchChange('cdBoTts', e.target.value)}><option value="">-</option>{options.cdBoTts?.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
              <td className="p-1 border-r"><select className="w-full outline-none" value={groupData.batch?.spinShift || ''} onChange={e => handleBatchChange('spinShift', e.target.value)}><option value="">-</option>{options.spinShift?.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
              <td className="p-1 border-r"><select className="w-full outline-none" value={groupData.batch?.inspShift || ''} onChange={e => handleBatchChange('inspShift', e.target.value)}><option value="">-</option>{options.inspShift?.map(o => <option key={o} value={o}>{o}</option>)}</select></td>
              <td className="p-1 border-r"><input type="text" className="w-full text-center outline-none" value={groupData.batch?.hangCount || ''} onChange={e => handleBatchChange('hangCount', e.target.value)} /></td>
              <td className="p-1"><input type="text" className="w-full text-center outline-none font-bold text-indigo-600" value={groupData.batch?.doffQty || ''} onChange={e => handleBatchChange('doffQty', e.target.value)} /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div className="border rounded-xl overflow-hidden">
        <div className="grid grid-cols-12 bg-gray-100 text-[10px] font-bold text-gray-500 py-2 text-center">
          <div className="col-span-1">錠</div>
          <div className="col-span-2">狀態</div>
          <div className="col-span-2">紡位</div>
          <div className="col-span-2">米長</div>
          <div className="col-span-5">原因說明</div>
        </div>
        <div className="max-h-96 overflow-y-auto">
          {currentRowsDisplay.map((row) => (
            <div key={row.id} className="grid grid-cols-12 border-t h-10 items-center text-center text-xs hover:bg-slate-50 transition-colors">
              <div className="col-span-1 border-r bg-gray-50 font-bold text-gray-400">{row.id}</div>
              <div className="col-span-2 border-r h-full">
                <select className="w-full h-full text-center outline-none font-bold" value={row.status || ''} onChange={e => handleRowChange(row.index, 'status', e.target.value)}>
                  <option value="">-</option>
                  <option value="O">O (斷)</option>
                  <option value="X">X (空)</option>
                </select>
              </div>
              <div className="col-span-2 border-r h-full"><input type="text" className="w-full h-full text-center outline-none" value={row.spinPos || ''} onChange={e => handleRowChange(row.index, 'spinPos', e.target.value)} /></div>
              <div className="col-span-2 border-r h-full"><input type="text" className="w-full h-full text-center outline-none" value={row.length || ''} onChange={e => handleRowChange(row.index, 'length', e.target.value)} /></div>
              <div className="col-span-5 h-full">
                <select className="w-full h-full px-2 outline-none text-[10px]" value={row.reason || ''} onChange={e => handleRowChange(row.index, 'reason', e.target.value)}>
                  <option value="">原因...</option>
                  {(row.status === 'O' ? options.breakReason : (row.status === 'X' ? options.emptyReason : []))?.map(o => <option key={o} value={o}>{o}</option>)}
                </select>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [activePage, setActivePage] = useState('1');
  const [allGroups, setAllGroups] = useState({});
  const [sharedHeader, setSharedHeader] = useState({ machineNo: '', personnel: '' });
  const [saveStatus, setSaveStatus] = useState('idle');
  const [options, setOptions] = useState({
    personnel: ['管理員'], testCard: ['A-1'], tube: ['T01'], cdBoTts: ['CD', 'BO', 'TTS'],
    spinShift: ['A', 'B', 'C'], inspShift: ['A', 'B', 'C'],
    breakReason: ['原紗斷', '繞軸'], emptyReason: ['機械故障', '清潔']
  });

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const pageDocId = `state_page_${activePage}`;
    return onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'app_state', pageDocId), (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        setAllGroups(data.allGroups || {});
        setSharedHeader(data.sharedHeader || { machineNo: '', personnel: '' });
      } else {
        const init = {}; UNIT_IDS.forEach(id => init[id] = getInitialGroupData(id));
        setAllGroups(init);
        setSharedHeader({ machineNo: '', personnel: '' });
      }
    });
  }, [user, activePage]);

  const persist = useCallback(async (newGroups, newHeader) => {
    if (!user) return;
    setSaveStatus('saving');
    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_state', `state_page_${activePage}`), {
        allGroups: newGroups || allGroups,
        sharedHeader: newHeader || sharedHeader,
        lastUpdated: serverTimestamp()
      });
      setSaveStatus('idle');
    } catch (e) { setSaveStatus('error'); }
  }, [user, activePage, allGroups, sharedHeader]);

  const updateGroup = (id, data) => {
    const next = { ...allGroups, [id]: data };
    setAllGroups(next);
    persist(next, sharedHeader);
  };

  const handleSharedUpdate = (field, val) => {
    const next = { ...sharedHeader, [field]: val };
    setSharedHeader(next);
    persist(allGroups, next);
  };

  const clearPage = () => {
    if (confirm(`確定要清空工作站 ${activePage} 的所有資料嗎？`)) {
      const init = {}; UNIT_IDS.forEach(id => init[id] = getInitialGroupData(id));
      setAllGroups(init);
      setSharedHeader({ machineNo: '', personnel: '' });
      persist(init, { machineNo: '', personnel: '' });
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8">
      <div className="max-w-4xl mx-auto">
        {/* 導航欄 */}
        <header className="bg-white/80 backdrop-blur shadow-lg rounded-2xl p-4 sticky top-4 z-50 mb-8 flex flex-wrap items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-600 p-2 rounded-lg text-white"><CheckCircle size={20}/></div>
            <h1 className="font-black text-xl text-slate-800">生產紀錄系統</h1>
          </div>
          <div className="flex gap-1 bg-slate-100 p-1 rounded-xl overflow-x-auto max-w-full">
            {FIXED_PAGE_IDS.map(id => (
              <button 
                key={id} 
                onClick={() => setActivePage(id)}
                className={`px-4 py-2 rounded-lg font-bold transition-all ${activePage === id ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-400 hover:bg-white'}`}
              >
                {id}
              </button>
            ))}
          </div>
          <div className="flex gap-2">
            <button onClick={clearPage} className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={20}/></button>
            <button onClick={() => window.print()} className="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors"><Printer size={20}/></button>
          </div>
        </header>

        {/* 標題與狀態 */}
        <div className="mb-8 px-2">
          <h2 className="text-4xl font-black text-slate-900 italic">工作站 {activePage}</h2>
          <p className="text-sm text-slate-400 mt-1">{saveStatus === 'saving' ? '正在同步雲端...' : '雲端同步完成'}</p>
        </div>

        {/* 單元列表 */}
        {UNIT_IDS.map(id => (
          <MachineUnit 
            key={`${activePage}-${id}`}
            id={id}
            groupData={allGroups[id]}
            sharedHeader={sharedHeader}
            options={options}
            onUpdate={updateGroup}
            onSharedUpdate={handleSharedUpdate}
          />
        ))}

        {/* 底部功能區 */}
        <div className="flex flex-col items-center gap-6 mt-12 mb-20 no-print">
          <button 
            onClick={clearPage}
            className="flex items-center gap-3 px-10 py-5 bg-red-500 text-white rounded-2xl font-black text-xl shadow-xl shadow-red-200 hover:bg-red-600 active:scale-95 transition-all"
          >
            <Trash2 size={24} />
            清空工作站 {activePage} 所有欄位
          </button>
          <p className="text-slate-400 text-xs font-bold">每個工作站皆為獨立存檔</p>
        </div>
      </div>
    </div>
  );
}
